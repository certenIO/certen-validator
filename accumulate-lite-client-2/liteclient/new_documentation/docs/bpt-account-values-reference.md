# BPT Account Values Reference

## Overview

This document details the exact value stored in the BPT for each account type in Accumulate. The BPT value is a 32-byte hash that serves both as:
1. A cryptographic proof of the account's complete state
2. A database key for cross-referencing related data

## File Structure

Account types are defined in YAML schema files and compiled to Go code:

### Schema Files (YAML)
- **User Accounts**: [`protocol/accounts.yml`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml)
- **System Accounts**: [`protocol/system.yml`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/system.yml)  
- **Enums**: [`protocol/enums.yml`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/enums.yml) (AccountType constants)

### Generated Code
- **Types**: [`protocol/types_gen.go`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go) (generated by `go run ./tools/cmd/gen-types`)
- **Enums**: [`protocol/enums_gen.go`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/enums_gen.go) (AccountType constants)

### Hash Computation
- **Production**: [`internal/core/execute/internal/bpt_prod.go`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/internal/core/execute/internal/bpt_prod.go)
- **Debug**: [`internal/core/execute/internal/bpt_debug.go`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/internal/core/execute/internal/bpt_debug.go)

## Important Schema Concepts

### Union Types
In the YAML schemas, `union: { type: account }` indicates that this type is part of the Account union type, allowing polymorphic handling of different account types.

### Virtual Fields
Fields marked with `virtual: true` and `non-binary: true` are:
- **Not serialized** in the binary format
- **Not included** in the BPT hash calculation
- **Available** as computed properties or references in the Go code

Example: KeyPage has a `KeyBook` field that is virtual - it references the parent key book but isn't stored in the account's state.

## Hash Computation Formula

For ALL account types, the BPT value is computed using the same formula (`bpt_prod.go:29-36`):

```go
BPT_Value = MerkleHash(
    SimpleHash(Main State),           // Component 1
    MerkleHash(Secondary State),      // Component 2
    MerkleHash(Chains),              // Component 3
    MerkleHash(Pending)              // Component 4
)
```

## Components Breakdown

### Component 1: Main State
The serialized protocol object for the account type (always included).

### Component 2: Secondary State
- **Directory**: Merkle hash of all sub-account URLs (for accounts with directories)
- **Events BPT**: Root hash of scheduled events (for system ledger only)

### Component 3: Chains
Merkle hash of all chain DAG roots in alphabetical order:
- Main chain (transaction history)
- Scratch chain (temporary data)
- Index chains (for indexed data)
- Custom chains (account-specific)

### Component 4: Pending
Merkle hash of:
- Pending transaction IDs
- Validator signatures
- Credit payments
- Authority votes
- Active signatures

## Account Types Reference

### 1. ADI (Accumulate Digital Identity)
**Type**: `protocol.ADI` / `AccountTypeIdentity`  
**YAML Definition**: [`protocol/accounts.yml:52-60`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml#L52-60)  
**Generated Go**: [`protocol/types_gen.go:29-34`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L29-34)  
**Main State Contains**:
```go
type ADI struct {
    Url         *url.URL
    Authorities []AuthorityEntry  // References to managing authorities
}
```
**Special Features**:
- Has a Directory of sub-accounts
- Sub-accounts appear as separate BPT entries
- Can own token accounts, data accounts, sub-ADIs

**BPT Value Components**:
1. **Main**: ADI struct with URL and authorities
2. **Secondary**: Directory URLs (all sub-accounts)
3. **Chains**: Main chain (ADI transactions)
4. **Pending**: Pending multi-sig transactions

---

### 2. Key Book
**Type**: `protocol.KeyBook` / `AccountTypeKeyBook`  
**YAML Definition**: [`protocol/accounts.yml:75-88`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml#L75-88)  
**Generated Go**: [`protocol/types_gen.go:469-476`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L469-476)  
**Main State Contains**:
```go
type KeyBook struct {
    Url         *url.URL
    BookType    BookType
    Authorities []AuthorityEntry
    PageCount   uint64
}
```
**Special Features**:
- Manages key pages
- Root authority for an ADI

**BPT Value Components**:
1. **Main**: KeyBook struct
2. **Secondary**: Empty (no directory)
3. **Chains**: Main chain (key book updates)
4. **Pending**: Pending authority changes

---

### 3. Key Page
**Type**: `protocol.KeyPage` / `AccountTypeKeyPage`  
**YAML Definition**: [`protocol/accounts.yml:89-125`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml#L89-125)  
**Generated Go**: [`protocol/types_gen.go:478-494`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L478-494)  
**Main State Contains**:
```go
type KeyPage struct {
    Url                  *url.URL
    CreditBalance        uint64
    AcceptThreshold      uint64
    RejectThreshold      uint64
    ResponseThreshold    uint64
    BlockThreshold       uint64
    Version              uint64
    Keys                 []*KeySpec
    TransactionBlacklist *AllowedTransactions  // Optional
    // KeyBook field is virtual (non-binary) - not stored in BPT hash
}
```
**Special Features**:
- Contains actual signing keys
- Manages credit balance for transactions
- Parent key book's pending transactions affect its hash

**BPT Value Components**:
1. **Main**: KeyPage struct with keys and thresholds
2. **Secondary**: Empty
3. **Chains**: Main chain (key updates)
4. **Pending**: Book's pending transactions (via parent reference)

---

### 4. Token Account (ADI)
**Type**: `protocol.TokenAccount` / `AccountTypeTokenAccount`  
**YAML Definition**: [`protocol/accounts.yml:61-74`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml#L61-74)  
**Generated Go**: [`protocol/types_gen.go:935-942`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L935-942)  
**Main State Contains**:
```go
type TokenAccount struct {
    Url         *url.URL
    Authorities []AuthorityEntry
    TokenUrl    *url.URL
    Balance     big.Int
}
```

**BPT Value Components**:
1. **Main**: TokenAccount with balance and token URL
2. **Secondary**: Empty
3. **Chains**: Main chain (token transactions)
4. **Pending**: Pending token transfers

---

### 5. Token Issuer
**Type**: `protocol.TokenIssuer` / `AccountTypeTokenIssuer`  
**YAML Definition**: [`protocol/accounts.yml:139-160`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml#L139-160)  
**Generated Go**: [`protocol/types_gen.go:944-954`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L944-954)  
**Main State Contains**:
```go
type TokenIssuer struct {
    Url         *url.URL
    Authorities []AuthorityEntry
    Symbol      string
    Precision   uint64
    Properties  *url.URL
    Issued      big.Int
    SupplyLimit *big.Int
}
```

**BPT Value Components**:
1. **Main**: TokenIssuer with token properties
2. **Secondary**: Empty
3. **Chains**: Main chain (issuance history)
4. **Pending**: Pending issuance transactions

---

### 6. Data Account (ADI)
**Type**: `protocol.DataAccount` / `AccountTypeDataAccount`  
**YAML Definition**: [`protocol/accounts.yml:126-138`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml#L126-138)  
**Generated Go**: [`protocol/types_gen.go:303-309`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L303-309)  
**Main State Contains**:
```go
type DataAccount struct {
    Url         *url.URL
    Authorities []AuthorityEntry
    Entry       DataEntry  // Latest data entry
}
```

**BPT Value Components**:
1. **Main**: DataAccount with latest entry
2. **Secondary**: Empty
3. **Chains**: Main chain (data entries), Data chain (entry history)
4. **Pending**: Pending data writes

---

### 7. Lite Token Account
**Type**: `protocol.LiteTokenAccount` / `AccountTypeLiteTokenAccount`  
**YAML Definition**: [`protocol/accounts.yml:30-44`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml#L30-44)  
**Generated Go**: [`protocol/types_gen.go:537-545`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L537-545)  
**Main State Contains**:
```go
type LiteTokenAccount struct {
    Url        *url.URL
    TokenUrl   *url.URL
    Balance    big.Int
    LockHeight uint64  // Optional lock
}
```

**BPT Value Components**:
1. **Main**: LiteTokenAccount with balance
2. **Secondary**: Empty
3. **Chains**: Main chain (transactions)
4. **Pending**: Pending transfers

---

### 8. Lite Identity
**Type**: `protocol.LiteIdentity` / `AccountTypeLiteIdentity`  
**YAML Definition**: [`protocol/accounts.yml:19-28`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml#L19-28)  
**Generated Go**: [`protocol/types_gen.go:529-535`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L529-535)  
**Main State Contains**:
```go
type LiteIdentity struct {
    Url           *url.URL
    CreditBalance uint64
    LastUsedOn    uint64
}
```

**BPT Value Components**:
1. **Main**: LiteIdentity with credits
2. **Secondary**: Empty
3. **Chains**: Main chain (credit/debit history)
4. **Pending**: Pending transactions

---

### 9. Lite Data Account
**Type**: `protocol.LiteDataAccount` / `AccountTypeLiteDataAccount`  
**YAML Definition**: [`protocol/accounts.yml:45-50`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/accounts.yml#L45-50)  
**Generated Go**: [`protocol/types_gen.go:523-527`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L523-527)  
**Main State Contains**:
```go
type LiteDataAccount struct {
    Url *url.URL
}
```

**BPT Value Components**:
1. **Main**: LiteDataAccount (minimal)
2. **Secondary**: Empty
3. **Chains**: Main chain (data entries)
4. **Pending**: Pending data writes

---

### 10. System Accounts

#### Anchor Ledger
**Type**: `protocol.AnchorLedger` / `AccountTypeAnchorLedger`  
**YAML Definition**: [`protocol/system.yml:53-79`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/system.yml#L53-79)  
**Generated Go**: [`protocol/types_gen.go:95-107`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L95-107)  
**Main State Contains**:
```go
type AnchorLedger struct {
    Url                      *url.URL
    MinorBlockSequenceNumber uint64
    MajorBlockIndex         uint64
    MajorBlockTime          time.Time
    PendingMajorBlockAnchors []*url.URL
}
```

#### System Ledger
**Type**: `protocol.SystemLedger` / `AccountTypeSystemLedger`  
**YAML Definition**: [`protocol/system.yml:6-38`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/system.yml#L6-38)  
**Generated Go**: [`protocol/types_gen.go:911-923`](https://gitlab.com/AccumulateNetwork/accumulate/-/blob/main/protocol/types_gen.go#L911-923)  
**Main State Contains**:
```go
type SystemLedger struct {
    Url            *url.URL
    Index          uint64
    Timestamp      time.Time
    AcmeBurnt      big.Int
    PendingUpdates []NetworkAccountUpdate
    Anchor         AnchorBody
    ExecutorVersion ExecutorVersion
}
```
**Special**: Includes Events BPT hash in secondary state

---

## Key Lookup Patterns

### Finding Account Data from BPT Entry

```go
// Given a BPT entry
bptKey := record.Key{"Account", url}
bptValue := [32]byte{...}  // The hash

// Access account using the key
account := batch.Account(url)

// Access account components
mainState := account.Main().Get()         // Protocol object
chains := account.Chains().Get()          // All chains
directory := account.Directory().Get()    // Sub-accounts (if ADI)
pending := account.Pending().Get()        // Pending transactions

// Use the hash as a database key
transaction := batch.Transaction(bptValue) // If hash references a transaction
```

### Navigating Account Hierarchies

```go
// ADI with sub-accounts
adi := batch.Account("acc://alice")
directory := adi.Directory().Get()

// Each sub-account has its own BPT entry
for _, subUrl := range directory {
    subAccount := batch.Account(subUrl)
    subHash, _ := subAccount.Hash()  // This hash is in BPT
    
    // Sub-account BPT entry:
    // Key: record.Key{"Account", subUrl}
    // Value: subHash
}
```

### Cross-References via Hash

```go
// Transaction chains contain hashes
chain := account.MainChain().Get()
entry := chain.Entry(i)
txHash := entry.Hash

// Use hash to get transaction
tx := batch.Transaction(txHash)

// Transaction may reference other accounts
// Those accounts have their own BPT entries
```

## Important Notes

1. **All account types use the same hash formula** - The difference is in what data populates each component

2. **Empty components contribute zero hashes** - Accounts without directories, pending transactions, etc. have those components as zero

3. **The hash is deterministic** - Same account state always produces the same hash

4. **Sub-accounts are independent** - Each has its own BPT entry with its own hash

5. **Hashes enable navigation** - The BPT value can be used as a database key to find related structures

6. **Validation requires all components** - To verify a BPT entry, you must hash all four components of the account

## Validation Process

To validate an account's BPT entry:

```go
// 1. Retrieve account data
account := batch.Account(url)
mainState := account.Main().Get()
directory := account.Directory().Get()
chains := account.Chains().Get()
pending := account.Pending().Get()

// 2. Compute hash
hasher := hash.Hasher{}
hasher.AddValue(mainState)           // Component 1
hasher.AddValue(hashDirectory())     // Component 2
hasher.AddValue(hashChains())        // Component 3
hasher.AddValue(hashPending())       // Component 4

computedHash := hasher.MerkleHash()

// 3. Compare with BPT value
bptEntry := bpt.Get(accountKey)
if computedHash != bptEntry.Value {
    // Validation failed - data tampered
}
```

## Conclusion

The BPT provides a uniform way to validate all account types while enabling efficient data retrieval. Every account type's BPT value is computed the same way, combining:
1. The account's protocol-defined state
2. Its directory of sub-accounts (if any)
3. All its transaction chains
4. Any pending transactions

This universal formula ensures consistency across the protocol while the hash values serve dual purposes as both validation checksums and database keys for navigation.